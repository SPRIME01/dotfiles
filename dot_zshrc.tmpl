# Managed by chezmoi - Zsh rc (WSL primary)
# Minimal, idempotent, and safe-by-default. Extend via separate files as needed.

# Shared dotfiles loader (prefers sourced path, falls back to common locations)
__dotfiles_try_source_common() {
  local candidate=""
  if [[ -n "${DOTFILES_ROOT:-}" && -f "${DOTFILES_ROOT}/.shell_common.sh" ]]; then
    candidate="${DOTFILES_ROOT}/.shell_common.sh"
  elif [[ -f "$HOME/dotfiles/.shell_common.sh" ]]; then
    candidate="$HOME/dotfiles/.shell_common.sh"
  elif [[ -f "{{ joinPath .chezmoi.sourceDir ".shell_common.sh" }}" ]]; then
    candidate="{{ joinPath .chezmoi.sourceDir ".shell_common.sh" }}"
  fi

  if [[ -n "$candidate" ]]; then
    # shellcheck disable=SC1090
    source "$candidate"
    return 0
  fi

  return 1
}

# Fix broken Docker completion to prevent compinit errors
if [[ -L /usr/share/zsh/vendor-completions/_docker ]] && [[ ! -e /usr/share/zsh/vendor-completions/_docker ]]; then
  # Temporarily hide broken Docker completion from compinit
  fpath=(${fpath[@]:#/usr/share/zsh/vendor-completions})
fi

__dotfiles_try_source_common
unset -f __dotfiles_try_source_common

# Theme configuration (Powerlevel10k via Oh My Zsh)
export ZSH_THEME="powerlevel10k/powerlevel10k"

# Oh My Zsh (optional)
if [[ -d "${ZSH:-$HOME/.oh-my-zsh}" ]]; then
  export ZSH="${ZSH:-$HOME/.oh-my-zsh}"
  # Load framework if available; plugins/themes configured separately
  source "$ZSH/oh-my-zsh.sh"
fi

# Direnv (project-scoped environments) — quiet by default
if command -v direnv >/dev/null 2>&1; then
  eval "$(direnv hook zsh)"
  [[ -z "${DIRENV_LOG_FORMAT:-}" ]] && export DIRENV_LOG_FORMAT=""
fi

{{/* template "templates/partials/direnv_hook.tmpl" . */}}
{{ include "templates/partials/direnv_hook.tmpl" }}

{{/* template "templates/partials/ssh_agent_bridge.tmpl" . */}}
{{ include "templates/partials/ssh_agent_bridge.tmpl" }}

{{/* template "templates/partials/projects_path.tmpl" . */}}
{{ include "templates/partials/projects_path.tmpl" }}

{{ if eq .chezmoi.os "linux" }}
{{   $rel := lower .chezmoi.kernel.osrelease }}
{{   if contains $rel "microsoft" }}
# WSL-specific PATH configuration
{{ include "templates/partials/wsl_path.tmpl" }}
{{   end }}
{{ else if eq .chezmoi.os "windows" }}
# Windows-specific PATH configuration
{{ include "templates/partials/windows_path.tmpl" }}
{{ else if eq .chezmoi.os "darwin" }}
# macOS-specific PATH configuration
{{ include "templates/partials/macos_path.tmpl" }}
{{ end }}

# End of minimal template — extend via ~/.zshrc.local as needed
[[ -f "$HOME/.zshrc.local" ]] && source "$HOME/.zshrc.local"
