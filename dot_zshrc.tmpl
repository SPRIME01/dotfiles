# Managed by chezmoi - Simplified Zsh configuration
# Optimized for speed and stability

# ============================================================================
# Powerlevel10k Instant Prompt (Must be first)
# ============================================================================

# Enable Powerlevel10k instant prompt. Should stay close to the top of ~/.zshrc.
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# ============================================================================
# Core Initialization (Simplified, crash-resistant)
# ============================================================================

# Use simplified shell init instead of complex .shell_common.sh
if [[ -f "$HOME/dotfiles/.shell_init.sh" ]]; then
    source "$HOME/dotfiles/.shell_init.sh"
elif [[ -f "{{ .chezmoi.sourceDir }}/.shell_init.sh" ]]; then
    source "{{ .chezmoi.sourceDir }}/.shell_init.sh"
fi

# ============================================================================
# Oh My Zsh Configuration
# ============================================================================

# Path to Oh My Zsh installation
export ZSH="${ZSH:-$HOME/.oh-my-zsh}"

# Theme
ZSH_THEME="powerlevel10k/powerlevel10k"

# Plugins (minimal for speed)
plugins=(
    git
    direnv
    mise
)

# Load Oh My Zsh (with error handling)
if [[ -f "$ZSH/oh-my-zsh.sh" ]]; then
    source "$ZSH/oh-my-zsh.sh" 2>/dev/null || true
fi

# ============================================================================
# Powerlevel10k Configuration
# ============================================================================

# Load P10k config if it exists
[[ -f ~/.p10k.zsh ]] && source ~/.p10k.zsh

# ============================================================================
# Platform-Specific Configuration
# ============================================================================

{{ if eq .chezmoi.os "linux" }}
{{   $rel := lower .chezmoi.kernel.osrelease }}
{{   if contains $rel "microsoft" }}
# WSL-specific configuration
export IS_WSL=1

# WSL PATH additions
if [[ -d "/mnt/c/Windows/System32" ]]; then
    export PATH="$PATH:/mnt/c/Windows/System32"
fi

# Convenience alias
if command -v cmd.exe >/dev/null 2>&1; then
    WIN_USER=$(cmd.exe /c "echo %USERNAME%" 2>/dev/null | tr -d '\r' 2>/dev/null)
    [[ -n "$WIN_USER" ]] && alias winhome="cd /mnt/c/Users/$WIN_USER"
fi
{{   end }}
{{ else if eq .chezmoi.os "darwin" }}
# macOS-specific configuration
if [[ -d "/opt/homebrew/bin" ]]; then
    eval "$(/opt/homebrew/bin/brew shellenv 2>/dev/null || true)"
fi
{{ end }}

# ============================================================================
# Local Customizations
# ============================================================================

# Load local customizations (not managed by chezmoi)
[[ -f "$HOME/.zshrc.local" ]] && source "$HOME/.zshrc.local"

# ============================================================================
# Performance Profiling (Optional)
# ============================================================================

if [[ "${DOTFILES_PROFILE:-}" == "1" ]]; then
    zmodload zsh/zprof
    zprof
fi
