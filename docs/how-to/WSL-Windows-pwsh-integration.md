# WSL ↔ Windows PowerShell 7 Integration

This document explains how this repository integrates Windows PowerShell 7 with the dotfiles stored in WSL, what changes were applied to fix startup errors, and what cleanup and quality‑of‑life improvements were added.

## Overview

- Source of truth lives in WSL: `~/dotfiles`.
- Windows PowerShell 7 `$PROFILE` sets `DOTFILES_ROOT` to the WSL UNC path and dot‑sources the main profile from this repo: `PowerShell/Microsoft.PowerShell_profile.ps1`.
- The main profile initializes Oh My Posh (OMP), loads modules, and bridges into the modular loader: `shell/integration.ps1` → `shell/loader.ps1`.

## Profile Flow

1. Windows `$PROFILE` (auto‑generated by `scripts/setup-windows-pwsh7-profile.ps1`):
   - Sets `DOTFILES_ROOT` to `\\wsl.localhost\<distro>\home\<user>\dotfiles`.
   - Ensures `PROJECTS_ROOT` exists.
   - Wakes WSL and waits briefly for the UNC path to become available.
   - Dot‑sources `PowerShell/Microsoft.PowerShell_profile.ps1` from the repo.

2. Main profile `PowerShell/Microsoft.PowerShell_profile.ps1`:
   - Resolves `DOTFILES_ROOT`, sets defaults, and loads `shell/integration.ps1`.
   - Initializes Oh My Posh with the configured theme.
   - Imports modules (Terminal‑Icons, PSReadLine) and defines utility functions.

3. Modular bridge `shell/integration.ps1` → `shell/loader.ps1`:
   - Loads common env, aliases, functions.
   - Loads platform‑specific and PowerShell‑specific config (`shell/powershell/config.ps1`).

## Fixes Applied

- Removed merge‑conflict markers that caused parse errors in:
  - `PowerShell/Microsoft.PowerShell_profile.ps1:71`
- Restored a clean Oh My Posh initialization block using:
  - `oh-my-posh init pwsh --config "<themePath>" | Invoke-Expression`
- Added a WSL UNC availability wait to the Windows wrapper profile generator to avoid race conditions on terminal startup.

## Cleanup of Old Profiles

The generator now backs up duplicate or legacy profile files (to avoid confusion between multiple locations). Candidates include (if present):

- `C:\Users\<you>\Documents\PowerShell\Microsoft.PowerShell_profile.ps1`
- Legacy WindowsPowerShell profile under `C:\Users\<you>\Documents\WindowsPowerShell\Microsoft.PowerShell_profile.ps1`

Any file not matching the active `$PROFILE` path is moved to `*.backup.<timestamp>`. OneDrive paths are intentionally not targeted to keep this project independent from OneDrive.

## Quality‑of‑Life Improvements

- Windows profile generator (`scripts/setup-windows-pwsh7-profile.ps1`):
  - Wakes WSL and waits up to ~3s for the UNC path before loading.
  - Emits a warning if the UNC path didn’t become available — the main profile’s fallback still provides basic commands.
  - Backs up duplicate profile files across Documents and WindowsPowerShell. OneDrive is not required.

## Verification Steps

1. Re‑generate the Windows `$PROFILE` from Windows PowerShell:
   ```powershell
   powershell.exe -ExecutionPolicy Bypass -File "\\wsl.localhost\Ubuntu-24.04\home\sprime01\dotfiles\scripts\setup-windows-pwsh7-profile.ps1"
   ```
2. Open a new PowerShell 7 window and confirm:
   - No parse errors.
   - Oh My Posh prompt is visible.
   - Optional: `Get-Command oh-my-posh`, `oh-my-posh --version`.
3. Confirm the theme file is reachable from Windows:
   ```powershell
   Test-Path "\\wsl.localhost\Ubuntu-24.04\home\sprime01\dotfiles\PowerShell\Themes\powerlevel10k_classic.omp.json"
   ```
4. Switch theme (optional):
   ```powershell
   settheme powerlevel10k-inspired
   ```

## Notes on Fonts

Use a Nerd Font in Windows Terminal for proper glyphs (e.g., “CaskaydiaCove NF”).

## Troubleshooting

- If you see a warning that the WSL UNC path didn’t become available:
  - Ensure WSL is installed and the distro is registered as the default.
  - Opening `\\wsl.localhost\<distro>\home` in Explorer should also wake it.
  - Reopen PowerShell to retry. Increase the wait if needed in the generator script.

## Files Touched

- Updated: `PowerShell/Microsoft.PowerShell_profile.ps1` (merge‑conflict cleanup, OMP init)
- Updated: `scripts/setup-windows-pwsh7-profile.ps1` (UNC wait, timeout message, old profiles cleanup)
